// printing utils
// TODO: bounds checking (print space if oob?)
svar_set __ascii_table "_!_#_%&___*+,-./0123456789_______ABCDEFGHIJKLMNOPQRSTUVWXYZ______abcdefghijklmnopqrstuvwxyz_____"
sar_function __ascii_get "svar_set __ascii_idx $1; svar_sub __ascii_idx 32; svar_set "
sar_function __ascii_lookup cond "" "svar_set __ascii_get_res $__ascii_table; __ascii_get_h"
sar_function __ascii_get_h "svar_substr __ascii_get_res $__ascii_idx 1"

// need something to represent the list of loop beginings?
// alternative is a function to find matching brace, slower for big programs?

// function definitions for the actions
sar_function __bf_left cond "var:__current_char=<" "svar_sub __data_ptr 1"
sar_function __bf_right cond "var:__current_char=>" "svar_add __data_ptr 1"
sar_function __bf_print cond "var:__current_char=." "sar_expand __ascii_get $$__tape_$__data_ptr; sar_expand sar_echo_nolf #ffffff $$__ascii_get_res"
sar_function __bf_inc cond "var:__current_char=+" "svar_add __tape_$__data_ptr 1"
sar_function __bf_dec cond "var:__current_char=-" "svar_sub __tape_$__data_ptr 1"
sar_function __bf_loop_open cond "var:__current_char=["  "svar_add __stack_ptr 1; sar_expand svar_set __stack_$$__stack_ptr $__prgm_ptr" // record on loop stack
sar_function __bf_loop_close cond "var:__current_char=]" "__bf_loop_close_jump; __bf_loop_close_exit" // go to beginning of loop or nothing
sar_function __bf_loop_close_jump cond "!var:__tape_$__data_ptr=0" "sar_expand svar_set __prgm_ptr $$__stack_$__stack_ptr" // jump back to beginning of loop
sar_function __bf_loop_close_exit cond "var:__tape_$__data_ptr=0" "svar_sub __stack_ptr 1" // exit loop

// main interpreter function
sar_function bf_exec "svar_set __bf_program $1; svar_set __data_ptr 0; svar_set __prgm_ptr 0; svar_set __stack_ptr 0; svar_set __current_char a; __bf_main_loop"

sar_function __bf_main_loop cond "!var:__current_char=0" "svar_set __current_char $__bf_program; svar_substr __current_char $__prgm_ptr 1; __bf_left; __bf_right; __bf_print; __bf_inc; __bf_dec; __bf_loop_open; __bf_loop_close; svar_add __prgm_ptr 1; __bf_main_loop"

// debug function
sar_function bf_debug "echo prgm: $__current_char @ $__prgm_ptr; sar_expand echo data: $$__tape_$__data_ptr @ $__data_ptr; echo stack_ptr: $__stack_ptr"